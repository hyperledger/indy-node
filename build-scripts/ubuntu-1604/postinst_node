#   Copyright 2017 Sovrin Foundation
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
#
#!/bin/bash

# it should be fixed

# workaround when .indy become regular file
if [ -f /home/indy/.indy ]; then
    rm /home/indy/.indy
fi

mkdir -p /etc/indy
mkdir -p /var/lib/indy
mkdir -p /var/log/indy

# create indy config if does not exist
if [ ! -f /etc/indy/indy_config.py ]; then
    touch /etc/indy/indy_config.py
    echo "enableStdOutLogging=False" >> /etc/indy/indy_config.py
    echo "baseDir = '/var/lib/indy'" >> /etc/indy/indy_config.py
    echo "NODE_BASE_DATA_DIR = baseDir" >> /etc/indy/indy_config.py
    echo "LOG_DIR = '/var/log/indy'" >> /etc/indy/indy_config.py
    echo "BACKUP_DIR = '/var/lib/indy/backup'" >> /etc/indy/indy_config.py
    echo "CLI_BASE_DIR = '~/.indy-cli/'" >> /etc/indy/indy_config.py
    echo "CLI_NETWORK_DIR = '~/.indy-cli/networks'" >> /etc/indy/indy_config.py
    echo "NODE_BASE_DATA_DIR = baseDir" >> /etc/indy/indy_config.py
fi

chmod -R ug+rwx /etc/indy
chmod -R ug+rwx /var/lib/indy
chmod -R ug+rwx /var/log/indy

# create indy cli folder if does not exist
mkdir -p /home/indy/.indy-cli
mkdir -p /home/indy/.indy-cli/networks
chown -R indy:indy /home/indy/.indy-cli
chmod -R ug+rwx /home/indy/.indy-cli

# init_indy_node script
cat <<EOF > /usr/local/bin/init_indy_node
#!/bin/bash

if [ \$# -lt 3 ]; then
    echo ""
    echo "Usage: \$0 name port client_port [seed]";
    echo "  name        - node name";
    echo "  port        - node port";
    echo "  client_port - node client port";
    echo "  seed        - node seed";
    echo ""
    exit 1;
fi

echo "NODE_NAME=\$1" > /etc/indy/indy.env
echo "NODE_PORT=\$2" >> /etc/indy/indy.env
echo "NODE_CLIENT_PORT=\$3" >> /etc/indy/indy.env

if [ -z \$4 ]; then
    init_indy_keys --name \$1
else
    init_indy_keys --name \$1 --seed \$4
fi
EOF

chmod +x /usr/local/bin/init_indy_node

# add systemd script
cat <<EOF > /etc/systemd/system/indy-node.service
[Unit]
Description=Indy Node
Requires=indy-node-control.service

[Service]
EnvironmentFile=/etc/indy/indy.env
ExecStart=/usr/bin/env python3 -O /usr/local/bin/start_indy_node \${NODE_NAME} \${NODE_PORT} \${NODE_CLIENT_PORT}
User=indy
Group=indy
Restart=on-failure
RestartSec=10
StartLimitBurst=10
StartLimitInterval=200
TimeoutSec=300

[Install]
WantedBy=multi-user.target
EOF


cat <<EOF > /etc/systemd/system/indy-node-control.service
[Unit]
Description=Service for upgrade of existing Indy Node and other operations
#Requires=indy.service
#After=indy.service
After=network.target

[Service]
Type=simple
EnvironmentFile=/etc/indy/node_control.conf
ExecStart=/usr/bin/env python3 -O /usr/local/bin/start_node_control_tool \$TEST_MODE --hold-ext \$HOLD_EXT
Restart=on-failure
RestartSec=10
StartLimitBurst=10
StartLimitInterval=200
TimeoutSec=300

[Install]
WantedBy=multi-user.target
EOF

HOLD_EXT_ADDED=$(grep HOLD_EXT /etc/indy/node_control.conf)
if [ ! -f /etc/indy/node_control.conf ] || [ -z "${HOLD_EXT_ADDED}" ]; then
    cat <<EOF > /etc/indy/node_control.conf
# Uncomment this to run agent in test mode:
#TEST_MODE=--test

TEST_MODE=
HOLD_EXT=\"\"
EOF
fi

mv /usr/local/bin/upgrade_indy_node_ubuntu1604.sh /usr/local/bin/upgrade_indy_node
mv /usr/local/bin/upgrade_indy_node_ubuntu1604_test.sh /usr/local/bin/upgrade_indy_node_test
mv /usr/local/bin/restart_indy_node_ubuntu1604.sh /usr/local/bin/restart_indy_node
mv /usr/local/bin/restart_sovrin_node_ubuntu1604.sh /usr/local/bin/restart_sovrin_node
mv /usr/local/bin/complete_rebranding_upgrade_ubuntu1604.sh /usr/local/bin/complete_rebranding_upgrade

chmod +x /usr/local/bin/upgrade_indy_node
chmod +x /usr/local/bin/upgrade_indy_node_test
chmod +x /usr/local/bin/restart_indy_node
chmod +x /usr/local/bin/restart_sovrin_node
chmod +x /usr/local/bin/complete_rebranding_upgrade

rm -f /usr/local/bin/delete_indy_node.bat /usr/local/bin/upgrade_indy_node_test.bat \
    /usr/local/bin/restart_indy_node.bat /usr/local/bin/install_nssm.bat /usr/local/bin/upgrade_indy_node.bat \
    /usr/local/bin/install_indy_node.bat /usr/local/bin/restart_upgrade_agent.bat

chown -R indy:indy /etc/indy
chown -R indy:indy /var/lib/indy
chown -R indy:indy /var/log/indy
chmod -R ug+rw /etc/indy
chmod -R ug+rw /var/lib/indy
chmod -R ug+rw /var/log/indy


# Automatically added from template:
if which py3compile >/dev/null 2>&1; then
	py3compile -O -p indy-node /usr/local/lib/python3.5/dist-packages/
fi

# End automatically added section